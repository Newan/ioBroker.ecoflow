{
  "version": 3,
  "sources": ["../src/main.ts"],
  "sourcesContent": ["/*\r\n * Created with @iobroker/create-adapter v2.2.0\r\n */\r\n\r\nimport * as utils from '@iobroker/adapter-core';\r\nimport axios from 'axios';\r\n\r\n\r\nclass Ecoflow extends utils.Adapter {\r\n\r\n    private sn='';\r\n    private apikey='';\r\n    private secretkey='';\r\n    private polltime=0;\r\n    private timeout=1000;\r\n    private adapterIntervals: any; //halten von allen Intervallen\r\n\r\n    public constructor(options: Partial<utils.AdapterOptions> = {}) {\r\n        super({\r\n            ...options,\r\n            name: 'ecoflow',\r\n        });\r\n        this.on('ready', this.onReady.bind(this));\r\n        this.on('unload', this.onUnload.bind(this));\r\n    }\r\n\r\n    private async onReady(): Promise<void> {\r\n\r\n        //P\u00FCfen die \u00FCbergabe da ist\r\n        if(this.config.sn) {\r\n            this.sn = this.config.sn;\r\n            this.log.debug('SN found:' + this.sn);\r\n        } else {\r\n            this.log.error('No secretkey is set, adapter stop')\r\n            return;\r\n        }\r\n\r\n        if(this.config.apikey) {\r\n            this.apikey = this.config.apikey;\r\n            this.log.debug('ApiKey found:' + this.apikey);\r\n        } else {\r\n            this.log.error('No apikey is set, adapter stop')\r\n            return;\r\n        }\r\n\r\n        if(this.config.secretkey) {\r\n            this.secretkey = this.config.secretkey;\r\n            this.log.debug('Secret-Key found:' + this.secretkey);\r\n        } else {\r\n            this.log.error('No secretkey is set, adapter stop')\r\n            return;\r\n        }\r\n\r\n        //Pr\u00FCfen Polltime\r\n        if(this.config.polltime > 0) {\r\n            this.polltime = this.config.polltime;\r\n            this.timeout = (this.polltime * 1000) - 500; //'500ms unter interval'\r\n\r\n        } else {\r\n            this.log.error('Wrong Polltime (polltime < 0), adapter stop')\r\n            return;\r\n        }\r\n\r\n        //holen f\u00FCr den Start einmal alle Daten\r\n        this.getEcoflowData();\r\n\r\n\r\n        //War alles ok, dann k\u00F6nnen wir die Daten abholen\r\n        this.adapterIntervals = this.setInterval(() => this.getEcoflowData(), this.polltime * 1000);\r\n\r\n    }\r\n\r\n    private onUnload(callback: () => void): void {\r\n        try {\r\n            clearInterval(this.adapterIntervals);\r\n            callback();\r\n        } catch (e) {\r\n            callback();\r\n        }\r\n    }\r\n\r\n    private getEcoflowData(): void {\r\n        this.log.debug('Ask Data from ecoflow cloud API');\r\n\r\n        try {\r\n            this.log.debug('call: ' + 'https://api.ecoflow.com/iot-service/open/api/device/queryDeviceQuota?sn=' + this.sn);\r\n            axios('https://api.ecoflow.com/iot-service/open/api/device/queryDeviceQuota?sn='+ this.sn, {\r\n                headers: {\r\n                    'Content-Type': 'application/json',\r\n                    'appKey': this.apikey,\r\n                    'secretKey': this.secretkey\r\n                },\r\n                timeout: this.timeout}).then( async response => {\r\n\r\n                this.log.debug('Get-Data from ecoflow:' + JSON.stringify(response.data));\r\n\r\n                if ('message' in response.data) {\r\n                    //APi returned always 200 but error message\r\n                    this.log.error(response.data.message);\r\n                    this.setState('info.connection', false, true);\r\n                } else {\r\n                    //Global status Items\r\n                    await this.setStateAsync('status.soc', { val: response.data.data.soc, ack: true });\r\n                    await this.setStateAsync('status.remainTime', { val: response.data.data.remainTime, ack: true });\r\n                    await this.setNewRemainTime(response.data.data.remainTime); //Time in Days/Hour/Minute\r\n                    await this.setStateAsync('status.wattsOutSum', { val: response.data.data.wattsOutSum, ack: true });\r\n                    await this.setStateAsync('status.wattsInSum', { val: response.data.data.wattsInSum, ack: true });\r\n\r\n                    this.setState('info.connection', true, true);\r\n                }\r\n            }).catch(error => {\r\n                this.log.error(error.message)\r\n                this.setState('info.connection', false, true);\r\n            });\r\n        } catch (error: unknown) {\r\n            this.setState('info.connection', false, true);\r\n            if (typeof error === 'string') {\r\n                this.log.error(error);\r\n            } else if (error instanceof Error) {\r\n                this.log.error(error.message);\r\n            }\r\n        }\r\n    }\r\n\r\n    private async setNewRemainTime(remaintime: number): Promise<void> {\r\n        await this.setStateAsync('status.remainTimeDay', { val: Math.floor((remaintime/60)/24), ack: true });\r\n        await this.setStateAsync('status.remainTimeHour', { val: Math.floor((remaintime/60)), ack: true });\r\n        await this.setStateAsync('status.remainTimeMinute', { val: Math.floor((remaintime % 60)), ack: true });\r\n    }\r\n}\r\n\r\nif (require.main !== module) {\r\n    // Export the constructor in compact mode\r\n    module.exports = (options: Partial<utils.AdapterOptions> | undefined) => new Ecoflow(options);\r\n} else {\r\n    // otherwise start the instance directly\r\n    (() => new Ecoflow())();\r\n}\r\n\r\n"],
  "mappings": "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",
  "names": ["axios"]
}
